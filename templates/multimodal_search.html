{% extends 'base.html' %}

{% block title %}å¤šæ¨¡æ€æ•°æ®æ•´åˆ - ç³–å°¿ç—…æ™ºèƒ½è¯Šæ–­åŠ©æ‰‹{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="page-title"><i class="bi bi-search me-2"></i>å¤šæ¨¡æ€æ•°æ®æ•´åˆ</h2>
        <p class="page-subtitle">PDF+Excel+MySQLç»Ÿä¸€æ£€ç´¢æ¥å£ï¼Œæ”¯æŒæŒ‡å—æ—¶æ•ˆæ€§éªŒè¯</p>
    </div>
</div>

<div class="row">
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-search me-2"></i>è·¨æºæ£€ç´¢
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">æ£€ç´¢å…³é”®è¯</label>
                    <input type="text" class="form-control" id="searchQuery" 
                           placeholder="å¦‚ï¼šé«˜è¡€å‹æ€¥ç—‡å¤„ç†" value="é«˜è¡€å‹æ€¥ç—‡å¤„ç†">
                </div>
                <div class="mb-3">
                    <label class="form-label">æ•°æ®æºè¿‡æ»¤</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includePdf" checked>
                        <label class="form-check-label">PDFæ–‡æ¡£</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeExcel" checked>
                        <label class="form-check-label">Excelæ•°æ®</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeMysql" checked>
                        <label class="form-check-label">MySQLæ•°æ®åº“</label>
                    </div>
                </div>
                <button class="btn btn-primary w-100" onclick="performSearch()">
                    <i class="bi bi-search me-2"></i>å¼€å§‹æ£€ç´¢
                </button>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <i class="bi bi-calendar-check me-2"></i>æŒ‡å—æ—¶æ•ˆæ€§éªŒè¯
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">æ›´æ–°æ—¥æœŸæˆªæ­¢</label>
                    <input type="date" class="form-control" id="dateFilter" value="2025-07-20">
                </div>
                <button class="btn btn-outline-primary w-100" onclick="validateTimeliness()">
                    <i class="bi bi-clock-history me-2"></i>éªŒè¯æ—¶æ•ˆæ€§
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-list-check me-2"></i>æ£€ç´¢ç»“æœ</span>
                <span class="badge bg-primary" id="resultCount">0 æ¡ç»“æœ</span>
            </div>
            <div class="card-body" id="searchResults">
                <div class="text-center text-muted py-5">
                    <i class="bi bi-search" style="font-size: 3rem;"></i>
                    <p class="mt-3">è¾“å…¥å…³é”®è¯å¼€å§‹æ£€ç´¢</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function performSearch() {
    const query = document.getElementById('searchQuery').value.trim();
    if (!query) {
        alert('è¯·è¾“å…¥æ£€ç´¢å…³é”®è¯');
        return;
    }
    
    const container = document.getElementById('searchResults');
    container.innerHTML = '<div class="text-center py-5"><div class="loading"><span></span><span></span><span></span></div><p class="mt-3">æ­£åœ¨æ£€ç´¢...</p></div>';
    
    fetch('/api/search', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            query: query,
            include_pdf: document.getElementById('includePdf').checked,
            include_excel: document.getElementById('includeExcel').checked,
            include_mysql: document.getElementById('includeMysql').checked
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            renderResults(data.data);
        } else {
            container.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        }
    })
    .catch(error => {
        container.innerHTML = '<div class="alert alert-danger">æ£€ç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
    });
}

function renderResults(data) {
    const container = document.getElementById('searchResults');
    document.getElementById('resultCount').textContent = `${data.total_count} æ¡ç»“æœ`;
    
    if (data.total_count === 0) {
        container.innerHTML = '<div class="alert alert-warning">æœªæ‰¾åˆ°ç›¸å…³ç»“æœ</div>';
        return;
    }
    
    let html = '';
    
    // æœ¯è¯­æ˜ å°„æç¤º
    if (data.term_replacements && data.term_replacements.length > 0) {
        html += '<div class="alert alert-info-custom mb-3"><i class="bi bi-info-circle me-2"></i>æœ¯è¯­æ ‡å‡†åŒ–ï¼š';
        data.term_replacements.forEach(r => {
            html += `<span class="badge bg-info me-1">${r.original} â†’ ${r.normalized}</span>`;
        });
        html += '</div>';
    }
    
    // PDFç»“æœ
    if (data.pdf_results && data.pdf_results.length > 0) {
        html += `<h6 class="mb-3"><span class="source-tag pdf">ğŸ“„ PDFæ–‡æ¡£</span> (${data.pdf_results.length}æ¡)</h6>`;
        data.pdf_results.forEach(hit => {
            html += `
                <div class="card mb-2">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <small class="text-muted">${hit.source?.filename || ''} ç¬¬${hit.source?.page || ''}é¡µ</small>
                            <span class="badge bg-secondary">${(hit.score * 100).toFixed(0)}%</span>
                        </div>
                        <p class="mb-0 small">${hit.content?.substring(0, 300)}...</p>
                    </div>
                </div>
            `;
        });
    }
    
    // Excelç»“æœ
    if (data.excel_results && data.excel_results.length > 0) {
        html += `<h6 class="mb-3 mt-4"><span class="source-tag excel">ğŸ“Š Excelæ•°æ®</span> (${data.excel_results.length}æ¡)</h6>`;
        data.excel_results.forEach(hit => {
            html += `
                <div class="card mb-2">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <small class="text-muted">${hit.source?.filename || ''} ç¬¬${hit.source?.row || ''}è¡Œ</small>
                            <span class="badge bg-secondary">${(hit.score * 100).toFixed(0)}%</span>
                        </div>
                        <p class="mb-0 small">${hit.content?.substring(0, 300)}...</p>
                    </div>
                </div>
            `;
        });
    }
    
    // MySQLç»“æœ
    if (data.mysql_results && data.mysql_results.length > 0) {
        html += `<h6 class="mb-3 mt-4"><span class="source-tag mysql">ğŸ—„ï¸ MySQLæ•°æ®åº“</span> (${data.mysql_results.length}æ¡)</h6>`;
        data.mysql_results.forEach(hit => {
            let evidence = hit.evidence_level ? `<span class="badge bg-success me-2">${hit.evidence_level}</span>` : '';
            html += `
                <div class="card mb-2">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <small class="text-muted">${hit.source?.table || ''}</small>
                            ${evidence}
                        </div>
                        <p class="mb-0 small">${hit.content}</p>
                    </div>
                </div>
            `;
        });
    }
    
    container.innerHTML = html;
}

function validateTimeliness() {
    const dateAfter = document.getElementById('dateFilter').value;
    const container = document.getElementById('searchResults');
    container.innerHTML = '<div class="text-center py-5"><div class="loading"><span></span><span></span><span></span></div><p class="mt-3">æ­£åœ¨éªŒè¯æŒ‡å—æ—¶æ•ˆæ€§...</p></div>';
    
    fetch('/api/guidelines/timeliness', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({date_after: dateAfter})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const guidelines = data.data;
            document.getElementById('resultCount').textContent = `${guidelines.length} æ¡ç¬¦åˆæ¡ä»¶`;
            
            if (guidelines.length === 0) {
                container.innerHTML = `<div class="alert alert-info">æ²¡æœ‰æ‰¾åˆ° ${dateAfter} ä¹‹åæ›´æ–°çš„æŒ‡å—</div>`;
                return;
            }
            
            let html = `<div class="alert alert-success-custom mb-3">
                <i class="bi bi-check-circle me-2"></i>æ‰¾åˆ° ${guidelines.length} æ¡ ${dateAfter} ä¹‹åæ›´æ–°çš„æŒ‡å—æ¨è
            </div>`;
            
            guidelines.forEach(g => {
                html += `
                    <div class="card mb-2">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <strong>${g.guideline_name}</strong>
                                <span class="badge bg-success">${g.recommendation_level}</span>
                            </div>
                            <p class="small mb-2">${g.recommendation_content}</p>
                            <div class="d-flex gap-2">
                                <span class="badge bg-light text-dark">${g.disease_type}</span>
                                <span class="badge bg-light text-dark">æ›´æ–°æ—¥æœŸ: ${g.update_date}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        } else {
            container.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        }
    })
    .catch(error => {
        container.innerHTML = '<div class="alert alert-danger">éªŒè¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
    });
}

document.getElementById('searchQuery').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') performSearch();
});
</script>
{% endblock %}

