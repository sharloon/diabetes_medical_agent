{% extends 'base.html' %}

{% block title %}术语标准化映射 - 糖尿病智能诊断助手{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="page-title"><i class="bi bi-translate me-2"></i>术语标准化映射</h2>
        <p class="page-subtitle">将医学俗称映射到标准术语，提高检索准确率</p>
    </div>
</div>

<div class="row">
    <div class="col-lg-5">
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-search me-2"></i>术语查询
            </div>
            <div class="card-body">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="termInput" 
                           placeholder="输入俗称或别名，如：心梗">
                    <button class="btn btn-primary" onclick="normalizeTerm()">
                        <i class="bi bi-arrow-right"></i> 标准化
                    </button>
                </div>
                
                <div id="normalizeResult" style="display: none;">
                    <div class="alert alert-success-custom">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-secondary me-2">原术语</span>
                            <span id="originalTerm"></span>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-primary me-2">标准术语</span>
                            <strong id="normalizedTerm"></strong>
                        </div>
                    </div>
                </div>
                
                <div id="suggestions" class="mt-3" style="display: none;">
                    <h6>相关建议</h6>
                    <div id="suggestionList"></div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <i class="bi bi-lightbulb me-2"></i>快速示例
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="tryTerm('心梗')">心梗</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="tryTerm('脑梗')">脑梗</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="tryTerm('中风')">中风</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="tryTerm('高血脂')">高血脂</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="tryTerm('络活喜')">络活喜</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="tryTerm('格华止')">格华止</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="tryTerm('心慌')">心慌</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-7">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-table me-2"></i>映射表</span>
                <input type="text" class="form-control form-control-sm" style="width: 200px;" 
                       placeholder="搜索..." id="tableSearch" oninput="filterTable()">
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 600px;">
                    <table class="table table-hover mb-0" id="mappingTable">
                        <thead class="sticky-top bg-white">
                            <tr>
                                <th>俗称/别名</th>
                                <th>标准术语</th>
                                <th>类别</th>
                            </tr>
                        </thead>
                        <tbody id="mappingTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadMappingTable();
});

function loadMappingTable() {
    fetch('/api/term/mappings')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const tbody = document.getElementById('mappingTableBody');
            let html = '';
            data.data.forEach(item => {
                let categoryBadge = '';
                switch(item.category) {
                    case '疾病名称':
                        categoryBadge = '<span class="badge bg-danger bg-opacity-75">疾病</span>';
                        break;
                    case '药物名称':
                        categoryBadge = '<span class="badge bg-primary bg-opacity-75">药物</span>';
                        break;
                    case '症状名称':
                        categoryBadge = '<span class="badge bg-warning bg-opacity-75">症状</span>';
                        break;
                    case '检查项目':
                        categoryBadge = '<span class="badge bg-info bg-opacity-75">检查</span>';
                        break;
                    default:
                        categoryBadge = '<span class="badge bg-secondary bg-opacity-75">其他</span>';
                }
                html += `
                    <tr>
                        <td>${item.alias}</td>
                        <td><strong>${item.standard}</strong></td>
                        <td>${categoryBadge}</td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }
    });
}

function normalizeTerm() {
    const term = document.getElementById('termInput').value.trim();
    if (!term) return;
    
    fetch('/api/term/normalize', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({term: term})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const result = data.data;
            
            document.getElementById('originalTerm').textContent = result.original;
            document.getElementById('normalizedTerm').textContent = result.normalized;
            document.getElementById('normalizeResult').style.display = 'block';
            
            if (result.suggestions && result.suggestions.length > 0) {
                let sugHtml = '';
                result.suggestions.forEach(sug => {
                    let confidence = Math.round(sug.confidence * 100);
                    sugHtml += `
                        <div class="d-flex align-items-center justify-content-between mb-2 p-2 bg-light rounded">
                            <span>${sug.term}</span>
                            <span class="badge bg-secondary">${confidence}%</span>
                        </div>
                    `;
                });
                document.getElementById('suggestionList').innerHTML = sugHtml;
                document.getElementById('suggestions').style.display = 'block';
            }
        }
    });
}

function tryTerm(term) {
    document.getElementById('termInput').value = term;
    normalizeTerm();
}

function filterTable() {
    const search = document.getElementById('tableSearch').value.toLowerCase();
    const rows = document.querySelectorAll('#mappingTableBody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(search) ? '' : 'none';
    });
}

document.getElementById('termInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') normalizeTerm();
});
</script>
{% endblock %}

