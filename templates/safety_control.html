{% extends 'base.html' %}

{% block title %}ä¼¦ç†å®‰å…¨æ§åˆ¶ - ç³–å°¿ç—…æ™ºèƒ½è¯Šæ–­åŠ©æ‰‹{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="page-title"><i class="bi bi-shield-exclamation me-2"></i>ä¼¦ç†å®‰å…¨æ§åˆ¶</h2>
        <p class="page-subtitle">é«˜é£é™©é¢„è­¦ã€è½¬è¯Šå†³ç­–ã€å­•å¦‡ç”¨è¯ç¦å¿Œæ£€æµ‹</p>
    </div>
</div>

<div class="row">
    <div class="col-lg-5">
        <!-- å®‰å…¨æ£€æŸ¥è¾“å…¥ -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-shield-check me-2"></i>å®‰å…¨æ£€æŸ¥
            </div>
            <div class="card-body">
                <ul class="nav nav-pills mb-3" id="safetyInputTabs">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#byPatientId">æŒ‰æ‚£è€…ID</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#byCustom">è‡ªå®šä¹‰ä¿¡æ¯</button>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="byPatientId">
                        <div class="mb-3">
                            <label class="form-label">æ‚£è€…ID</label>
                            <input type="text" class="form-control" id="safetyPatientId">
                        </div>
                        <button class="btn btn-primary w-100" onclick="checkSafetyById()">
                            <i class="bi bi-shield-check me-2"></i>æ‰§è¡Œå®‰å…¨æ£€æŸ¥
                        </button>
                    </div>
                    
                    <div class="tab-pane fade" id="byCustom">
                        <div class="mb-3">
                            <label class="form-label">æ€§åˆ«</label>
                            <select class="form-select" id="customGender">
                                <option value="ç”·">ç”·</option>
                                <option value="å¥³">å¥³</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">å¹´é¾„</label>
                            <input type="number" class="form-control" id="customAge" value="35">
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isPregnant">
                                <label class="form-check-label">å­•å¦‡</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">è¡€å‹ (æ”¶ç¼©å‹/èˆ’å¼ å‹)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="customSbp" value="158">
                                <span class="input-group-text">/</span>
                                <input type="number" class="form-control" id="customDbp" value="96">
                                <span class="input-group-text">mmHg</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">å½“å‰ç”¨è¯ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                            <input type="text" class="form-control" id="customMeds" 
                                   placeholder="å¦‚ï¼šä¾é‚£æ™®åˆ©,æ°¨æ°¯åœ°å¹³" value="ä¾é‚£æ™®åˆ©,æ°¨æ°¯åœ°å¹³">
                        </div>
                        <button class="btn btn-primary w-100" onclick="checkSafetyByCustom()">
                            <i class="bi bi-shield-check me-2"></i>æ‰§è¡Œå®‰å…¨æ£€æŸ¥
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç´§æ€¥æƒ…å†µå¤„ç† -->
        <div class="card">
            <div class="card-header bg-danger text-white">
                <i class="bi bi-exclamation-triangle me-2"></i>ç´§æ€¥æƒ…å†µå¤„ç†
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">ç—‡çŠ¶æè¿°</label>
                    <textarea class="form-control" id="emergencySymptoms" rows="2" 
                              placeholder="å¦‚ï¼šå¤´ç—›å‘•å3å°æ—¶">å¤´ç—›å‘•å3å°æ—¶ï¼Œè§†ç‰©æ¨¡ç³Š</textarea>
                </div>
                <div class="row mb-3">
                    <div class="col-6">
                        <label class="form-label">æ”¶ç¼©å‹</label>
                        <input type="number" class="form-control" id="emergencySbp" value="190">
                    </div>
                    <div class="col-6">
                        <label class="form-label">èˆ’å¼ å‹</label>
                        <input type="number" class="form-control" id="emergencyDbp" value="120">
                    </div>
                </div>
                <button class="btn btn-danger w-100" onclick="processEmergency()">
                    <i class="bi bi-lightning me-2"></i>ç´§æ€¥å¤„ç†è¯„ä¼°
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-lg-7">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-file-medical me-2"></i>å®‰å…¨æ£€æŸ¥æŠ¥å‘Š
            </div>
            <div class="card-body" id="safetyResult">
                <div class="text-center text-muted py-5">
                    <i class="bi bi-shield" style="font-size: 3rem;"></i>
                    <p class="mt-3">æ‰§è¡Œå®‰å…¨æ£€æŸ¥åæ˜¾ç¤ºæŠ¥å‘Š</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æµ‹è¯•æ¡ˆä¾‹å¿«æ·å…¥å£ -->
<div class="card mt-4">
    <div class="card-header">
        <i class="bi bi-lightning me-2"></i>æµ‹è¯•æ¡ˆä¾‹
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <div class="p-3 bg-danger bg-opacity-10 rounded">
                    <h6 class="text-danger">å­•å¦‡ACEIç¦å¿Œæµ‹è¯•</h6>
                    <p class="small mb-2">35å²å­•å¦‡ï¼Œè¡€å‹158/96mmHgï¼Œæ­£åœ¨ä½¿ç”¨ä¾é‚£æ™®åˆ©</p>
                    <button class="btn btn-sm btn-outline-danger" onclick="testPregnancy()">æ‰§è¡Œæµ‹è¯•</button>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-3 bg-warning bg-opacity-10 rounded">
                    <h6 class="text-warning">é«˜è¡€å‹æ€¥ç—‡æµ‹è¯•</h6>
                    <p class="small mb-2">æ”¶ç¼©å‹190mmHgï¼Œå¤´ç—›å‘•å3å°æ—¶</p>
                    <button class="btn btn-sm btn-outline-warning" onclick="testEmergency()">æ‰§è¡Œæµ‹è¯•</button>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-3 bg-info bg-opacity-10 rounded">
                    <h6 class="text-info">è¯ç‰©ç›¸äº’ä½œç”¨æµ‹è¯•</h6>
                    <p class="small mb-2">åŒæ—¶ä½¿ç”¨ACEIå’Œä¿é’¾åˆ©å°¿å‰‚</p>
                    <button class="btn btn-sm btn-outline-info" onclick="testInteraction()">æ‰§è¡Œæµ‹è¯•</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// æ£€æŸ¥URLå‚æ•°æ‰§è¡Œé¢„è®¾æµ‹è¯•
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const testType = urlParams.get('test');
    
    if (testType === 'pregnancy') {
        testPregnancy();
    } else if (testType === 'emergency') {
        testEmergency();
    }
});

function checkSafetyById() {
    const patientId = document.getElementById('safetyPatientId').value.trim();
    if (!patientId) {
        alert('è¯·è¾“å…¥æ‚£è€…ID');
        return;
    }
    
    executeSafetyCheck({patient_id: patientId});
}

function checkSafetyByCustom() {
    const customProfile = {
        gender: document.getElementById('customGender').value,
        age: parseInt(document.getElementById('customAge').value),
        hypertension_assessment: {
            sbp: parseInt(document.getElementById('customSbp').value),
            dbp: parseInt(document.getElementById('customDbp').value)
        },
        medications: document.getElementById('customMeds').value.split(',').map(m => ({
            drug_name: m.trim()
        })),
        diagnoses: []
    };
    
    // æ·»åŠ å­•å¦‡è¯Šæ–­
    if (document.getElementById('isPregnant').checked) {
        customProfile.diagnoses.push({diagnosis_name: 'å¦Šå¨ '});
    }
    
    executeSafetyCheck({custom_profile: customProfile});
}

function executeSafetyCheck(params) {
    const container = document.getElementById('safetyResult');
    container.innerHTML = '<div class="text-center py-5"><div class="loading"><span></span><span></span><span></span></div><p class="mt-3">æ­£åœ¨æ‰§è¡Œå®‰å…¨æ£€æŸ¥...</p></div>';
    
    fetch('/api/safety/check', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(params)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            renderSafetyReport(data.data);
        } else {
            container.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        }
    });
}

function renderSafetyReport(data) {
    const container = document.getElementById('safetyResult');
    const checkResult = data.check_result;
    
    let html = '<h5><i class="bi bi-clipboard-check me-2"></i>å®‰å…¨æ£€æŸ¥æŠ¥å‘Š</h5>';
    
    // æ€»ä½“è¯„ä¼°
    if (checkResult.is_safe) {
        html += '<div class="alert alert-success-custom"><i class="bi bi-check-circle me-2"></i>âœ… æœªå‘ç°å±æ€¥å®‰å…¨é—®é¢˜</div>';
    } else {
        html += '<div class="alert alert-danger-custom"><i class="bi bi-x-circle me-2"></i>âŒ å­˜åœ¨éœ€è¦ç«‹å³å¤„ç†çš„å®‰å…¨é—®é¢˜</div>';
    }
    
    // å±æ€¥è­¦æŠ¥
    if (checkResult.emergency_alerts && checkResult.emergency_alerts.length > 0) {
        html += '<div class="card mb-3 border-danger"><div class="card-header bg-danger text-white">ğŸš¨ å±æ€¥è­¦æŠ¥</div><div class="card-body">';
        checkResult.emergency_alerts.forEach(alert => {
            html += `
                <div class="mb-3">
                    <strong>${alert.message}</strong>
                    ${alert.immediate_action ? '<ul class="mt-2 mb-0">' + alert.immediate_action.map(a => `<li>${a}</li>`).join('') + '</ul>' : ''}
                    ${alert.requires_referral ? '<p class="mt-2 mb-0 text-danger"><strong>éœ€è¦è½¬è¯Šè‡³ï¼š</strong>' + alert.referral_department + '</p>' : ''}
                </div>
            `;
        });
        html += '</div></div>';
    }
    
    // ç¦å¿Œç—‡è­¦å‘Š
    if (checkResult.contraindications && checkResult.contraindications.length > 0) {
        html += '<div class="card mb-3 border-warning"><div class="card-header bg-warning">âš ï¸ ç¦å¿Œç—‡è­¦å‘Š</div><div class="card-body">';
        checkResult.contraindications.forEach(contra => {
            html += `
                <div class="mb-3">
                    <strong>${contra.message}</strong>
                    ${contra.reason ? `<p class="small text-muted mb-1">åŸå› ï¼š${contra.reason}</p>` : ''}
                    ${contra.alternative ? `<p class="small text-success mb-1">æ›¿ä»£æ–¹æ¡ˆï¼š${contra.alternative}</p>` : ''}
                    ${contra.action ? `<p class="small text-primary mb-0">å»ºè®®æ“ä½œï¼š${contra.action}</p>` : ''}
                </div>
            `;
        });
        html += '</div></div>';
    }
    
    // è¯ç‰©ç›¸äº’ä½œç”¨
    if (checkResult.interactions && checkResult.interactions.length > 0) {
        html += '<div class="card mb-3 border-info"><div class="card-header bg-info text-white">ğŸ’Š è¯ç‰©ç›¸äº’ä½œç”¨</div><div class="card-body">';
        checkResult.interactions.forEach(interaction => {
            html += `<div class="mb-2">${interaction.message}</div>`;
        });
        html += '</div></div>';
    }
    
    // ä¸€èˆ¬è­¦å‘Š
    if (checkResult.warnings && checkResult.warnings.length > 0) {
        html += '<div class="card mb-3"><div class="card-header">ğŸ“‹ æ³¨æ„äº‹é¡¹</div><div class="card-body">';
        checkResult.warnings.forEach(warning => {
            html += `
                <div class="mb-2">
                    ${warning.message}
                    ${warning.considerations ? '<ul class="small mt-1 mb-0">' + warning.considerations.map(c => `<li>${c}</li>`).join('') + '</ul>' : ''}
                </div>
            `;
        });
        html += '</div></div>';
    }
    
    // å®Œæ•´æŠ¥å‘Š
    if (data.report) {
        html += `<div class="mt-4"><h6>å®Œæ•´æŠ¥å‘Š</h6><pre class="bg-light p-3 rounded small">${data.report}</pre></div>`;
    }
    
    container.innerHTML = html;
}

function processEmergency() {
    const symptoms = document.getElementById('emergencySymptoms').value.trim();
    const sbp = parseInt(document.getElementById('emergencySbp').value);
    const dbp = parseInt(document.getElementById('emergencyDbp').value);
    
    if (!symptoms) {
        alert('è¯·è¾“å…¥ç—‡çŠ¶æè¿°');
        return;
    }
    
    const container = document.getElementById('safetyResult');
    container.innerHTML = '<div class="text-center py-5"><div class="loading"><span></span><span></span><span></span></div><p class="mt-3">æ­£åœ¨è¿›è¡Œç´§æ€¥è¯„ä¼°...</p></div>';
    
    fetch('/api/emergency/process', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            symptoms: symptoms,
            vital_signs: {sbp: sbp, dbp: dbp}
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.data.success) {
            const result = data.data;
            let html = '<h5><i class="bi bi-lightning me-2"></i>ç´§æ€¥æƒ…å†µè¯„ä¼°</h5>';
            
            if (result.is_emergency) {
                html += '<div class="alert alert-danger"><strong>ğŸš¨ é«˜è¡€å‹æ€¥ç—‡ç¡®è®¤</strong></div>';
            }
            
            // ç«‹å³è¡ŒåŠ¨
            if (result.immediate_actions) {
                html += '<div class="card mb-3 border-danger"><div class="card-header bg-danger text-white">ç«‹å³é‡‡å–æªæ–½</div><div class="card-body"><ol class="mb-0">';
                result.immediate_actions.forEach(action => {
                    html += `<li>${action}</li>`;
                });
                html += '</ol></div></div>';
            }
            
            // AIå“åº”
            if (result.response) {
                html += `<div class="bg-light p-3 rounded">${renderMarkdown(result.response)}</div>`;
            }
            
            // è½¬è¯Šå»ºè®®
            if (result.requires_referral) {
                html += `<div class="alert alert-warning mt-3"><strong>âš ï¸ éœ€è¦ç´§æ€¥è½¬è¯Šè‡³ï¼š${result.referral_department}</strong></div>`;
            }
            
            container.innerHTML = html;
        } else {
            container.innerHTML = `<div class="alert alert-danger">${data.data?.error || 'è¯„ä¼°å¤±è´¥'}</div>`;
        }
    });
}

// æµ‹è¯•æ¡ˆä¾‹
function testPregnancy() {
    document.getElementById('customGender').value = 'å¥³';
    document.getElementById('customAge').value = '35';
    document.getElementById('isPregnant').checked = true;
    document.getElementById('customSbp').value = '158';
    document.getElementById('customDbp').value = '96';
    document.getElementById('customMeds').value = 'ä¾é‚£æ™®åˆ©,æ°¨æ°¯åœ°å¹³';
    
    // åˆ‡æ¢åˆ°è‡ªå®šä¹‰è¾“å…¥tab
    const tab = new bootstrap.Tab(document.querySelector('[data-bs-target="#byCustom"]'));
    tab.show();
    
    checkSafetyByCustom();
}

function testEmergency() {
    document.getElementById('emergencySymptoms').value = 'å¤´ç—›å‘•å3å°æ—¶ï¼Œè§†ç‰©æ¨¡ç³Š';
    document.getElementById('emergencySbp').value = '190';
    document.getElementById('emergencyDbp').value = '120';
    processEmergency();
}

function testInteraction() {
    document.getElementById('customGender').value = 'ç”·';
    document.getElementById('customAge').value = '60';
    document.getElementById('isPregnant').checked = false;
    document.getElementById('customSbp').value = '150';
    document.getElementById('customDbp').value = '95';
    document.getElementById('customMeds').value = 'ä¾é‚£æ™®åˆ©,èºå†…é…¯';
    
    const tab = new bootstrap.Tab(document.querySelector('[data-bs-target="#byCustom"]'));
    tab.show();
    
    checkSafetyByCustom();
}
</script>
{% endblock %}

