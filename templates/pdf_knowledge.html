{% extends 'base.html' %}

{% block title %}PDF知识库构建 - 糖尿病智能诊断助手{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="page-title"><i class="bi bi-file-pdf me-2"></i>PDF知识库构建</h2>
        <p class="page-subtitle">提取文档目录结构、关键表格，构建向量检索索引</p>
    </div>
</div>

<div class="row">
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-files me-2"></i>文档列表
            </div>
            <div class="card-body">
                <div id="pdfList">
                    <div class="text-center py-3">
                        <div class="loading"><span></span><span></span><span></span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-info-circle me-2"></i>文档详情
            </div>
            <div class="card-body" id="pdfDetail">
                <div class="text-center text-muted py-5">
                    <i class="bi bi-arrow-left-circle" style="font-size: 3rem;"></i>
                    <p class="mt-3">请从左侧选择一个文档查看详情</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadPdfList();
});

function loadPdfList() {
    fetch('/api/pdf/info')
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('pdfList');
        if (data.success && data.data.length > 0) {
            let html = '<div class="list-group list-group-flush">';
            data.data.forEach(pdf => {
                html += `
                    <button class="list-group-item list-group-item-action" 
                            onclick="loadPdfDetail('${pdf.filename}')">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-file-pdf text-danger me-3" style="font-size: 1.5rem;"></i>
                            <div>
                                <div class="fw-bold">${pdf.filename}</div>
                                <small class="text-muted">${pdf.total_pages}页</small>
                            </div>
                        </div>
                    </button>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        } else {
            container.innerHTML = '<div class="alert alert-warning">未找到PDF文档</div>';
        }
    })
    .catch(error => {
        document.getElementById('pdfList').innerHTML = 
            '<div class="alert alert-danger">加载失败</div>';
    });
}

function loadPdfDetail(filename) {
    const container = document.getElementById('pdfDetail');
    container.innerHTML = '<div class="text-center py-5"><div class="loading"><span></span><span></span><span></span></div><p class="mt-3">正在提取文档内容...</p></div>';
    
    fetch(`/api/pdf/extract/${encodeURIComponent(filename)}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const info = data.data.info;
            const toc = data.data.toc;
            const tables = data.data.tables;
            
            let html = `
                <div class="mb-4">
                    <h5><i class="bi bi-file-text me-2"></i>文档信息</h5>
                    <table class="table table-sm">
                        <tr><td class="fw-bold" style="width:120px">文件名</td><td>${info.filename}</td></tr>
                        <tr><td class="fw-bold">总页数</td><td>${info.total_pages}页</td></tr>
                        <tr><td class="fw-bold">文件大小</td><td>${(info.file_size/1024/1024).toFixed(2)} MB</td></tr>
                        <tr><td class="fw-bold">修改时间</td><td>${info.modified_time || 'N/A'}</td></tr>
                    </table>
                </div>
            `;
            
            // 目录结构
            if (toc && toc.length > 0) {
                html += `
                    <div class="mb-4">
                        <h5><i class="bi bi-list-nested me-2"></i>目录结构</h5>
                        <div class="bg-light rounded p-3" style="max-height: 300px; overflow-y: auto;">
                            <ul class="list-unstyled mb-0">
                `;
                toc.forEach(item => {
                    html += `<li class="py-1"><i class="bi bi-chevron-right me-2"></i>${item.title} <span class="badge bg-secondary">${item.page}</span></li>`;
                });
                html += '</ul></div></div>';
            }
            
            // 表格
            if (tables && tables.length > 0) {
                html += `
                    <div class="mb-4">
                        <h5><i class="bi bi-table me-2"></i>提取的表格 (${tables.length}个)</h5>
                        <div class="accordion" id="tablesAccordion">
                `;
                tables.forEach((table, idx) => {
                    html += `
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#table${idx}">
                                    表格 ${idx+1} (第${table.source.page}页)
                                </button>
                            </h2>
                            <div id="table${idx}" class="accordion-collapse collapse" 
                                 data-bs-parent="#tablesAccordion">
                                <div class="accordion-body">
                                    <pre class="bg-light p-3 rounded" style="font-size: 0.85rem; white-space: pre-wrap;">${table.content}</pre>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div></div>';
            }
            
            container.innerHTML = html;
        } else {
            container.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        }
    })
    .catch(error => {
        container.innerHTML = '<div class="alert alert-danger">加载详情失败</div>';
    });
}
</script>
{% endblock %}

