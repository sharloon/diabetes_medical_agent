{% extends 'base.html' %}

{% block title %}智能对话 - 糖尿病智能诊断助手{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="page-title"><i class="bi bi-chat-dots me-2"></i>智能对话</h2>
        <p class="page-subtitle">基于知识库的智能问答系统，支持高血压、糖尿病相关咨询</p>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-robot me-2"></i>对话窗口</span>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearChat()">
                    <i class="bi bi-trash"></i> 清空对话
                </button>
            </div>
            <div class="card-body p-0">
                <div class="chat-container" id="chatContainer">
                    <div class="chat-message ai">
                        <div class="chat-avatar ai"><i class="bi bi-robot"></i></div>
                        <div class="chat-bubble">
                            您好！我是糖尿病智能诊断助手，可以为您提供高血压、糖尿病相关的医疗咨询服务。<br><br>
                            您可以询问：
                            <ul class="mb-0 mt-2">
                                <li>什么是高血压？</li>
                                <li>高血压急症如何处理？</li>
                                <li>糖尿病的治疗方案有哪些？</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="p-3 border-top">
                    <div class="input-group">
                        <input type="text" class="form-control" id="chatInput" 
                               placeholder="请输入您的问题..." 
                               onkeypress="if(event.key==='Enter') sendMessage()">
                        <button class="btn btn-primary" onclick="sendMessage()">
                            <i class="bi bi-send"></i> 发送
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- 患者上下文 -->
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-person me-2"></i>患者上下文（可选）
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">患者ID</label>
                    <input type="text" class="form-control" id="patientId" 
                           placeholder="输入患者ID绑定上下文">
                </div>
                <button class="btn btn-outline-primary btn-sm w-100" onclick="loadPatient()">
                    <i class="bi bi-person-check"></i> 加载患者信息
                </button>
                <div id="patientInfo" class="mt-3" style="display: none;"></div>
            </div>
        </div>
        
        <!-- 快捷问题 -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-lightning me-2"></i>快捷问题
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-secondary btn-sm text-start" 
                            onclick="askQuestion('什么是高血压？')">
                        什么是高血压？
                    </button>
                    <button class="btn btn-outline-secondary btn-sm text-start" 
                            onclick="askQuestion('高血压急症处理')">
                        高血压急症处理
                    </button>
                    <button class="btn btn-outline-secondary btn-sm text-start" 
                            onclick="askQuestion('糖尿病的治疗方案')">
                        糖尿病的治疗方案
                    </button>
                    <button class="btn btn-outline-secondary btn-sm text-start" 
                            onclick="askQuestion('ACEI类药物的禁忌症')">
                        ACEI类药物的禁忌症
                    </button>
                    <button class="btn btn-outline-secondary btn-sm text-start" 
                            onclick="askQuestion('骨折怎么治疗')">
                        骨折怎么治疗（测试无知识）
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let chatHistory = [];

function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // 显示用户消息
    appendMessage(message, 'user');
    input.value = '';
    
    // 显示加载状态
    const loadingId = appendMessage('<div class="loading"><span></span><span></span><span></span></div>', 'ai', true);
    
    // 发送请求
    const patientId = document.getElementById('patientId').value;
    
    fetch('/api/chat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            query: message,
            patient_id: patientId || null,
            history: chatHistory.slice(-10)
        })
    })
    .then(response => response.json())
    .then(data => {
        // 移除加载状态
        document.getElementById(loadingId)?.remove();
        
        if (data.success) {
            const result = data.data;
            let response = result.answer || '抱歉，暂时无法回答您的问题。';
            
            // 添加来源信息
            if (result.sources && result.sources.length > 0) {
                response += '\n\n<div class="mt-3"><small class="text-muted">参考来源：</small><br>';
                result.sources.forEach(source => {
                    response += formatSource(source) + ' ';
                });
                response += '</div>';
            }
            
            // 添加术语映射信息
            if (result.term_info) {
                response += `\n<div class="mt-2"><small class="text-info">${result.term_info}</small></div>`;
            }
            
            appendMessage(response, 'ai');
            
            // 更新历史
            chatHistory.push({role: 'user', content: message});
            chatHistory.push({role: 'assistant', content: result.answer});
        } else {
            appendMessage('抱歉，服务暂时不可用：' + (data.error || '未知错误'), 'ai');
        }
    })
    .catch(error => {
        document.getElementById(loadingId)?.remove();
        appendMessage('网络错误，请稍后重试。', 'ai');
    });
}

function appendMessage(content, type, isLoading = false) {
    const container = document.getElementById('chatContainer');
    const messageId = 'msg-' + Date.now();
    
    const avatar = type === 'ai' 
        ? '<div class="chat-avatar ai"><i class="bi bi-robot"></i></div>'
        : '<div class="chat-avatar user"><i class="bi bi-person"></i></div>';
    
    const bubble = isLoading ? content : renderMarkdown(content);
    
    const html = `
        <div class="chat-message ${type}" id="${messageId}">
            ${avatar}
            <div class="chat-bubble">${bubble}</div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', html);
    container.scrollTop = container.scrollHeight;
    
    return messageId;
}

function askQuestion(question) {
    document.getElementById('chatInput').value = question;
    sendMessage();
}

function clearChat() {
    const container = document.getElementById('chatContainer');
    container.innerHTML = `
        <div class="chat-message ai">
            <div class="chat-avatar ai"><i class="bi bi-robot"></i></div>
            <div class="chat-bubble">对话已清空，请开始新的咨询。</div>
        </div>
    `;
    chatHistory = [];
}

function loadPatient() {
    const patientId = document.getElementById('patientId').value.trim();
    if (!patientId) {
        alert('请输入患者ID');
        return;
    }
    
    fetch(`/api/patient/profile/${patientId}`)
    .then(response => response.json())
    .then(data => {
        const infoDiv = document.getElementById('patientInfo');
        if (data.success && data.data.success) {
            const profile = data.data;
            infoDiv.innerHTML = `
                <div class="alert alert-success-custom small">
                    <strong>已加载患者：</strong><br>
                    姓名：${profile.name || 'N/A'}<br>
                    年龄：${profile.age || 'N/A'}岁<br>
                    性别：${profile.gender || 'N/A'}<br>
                    风险等级：${profile.risk_assessment?.overall_risk_level || 'N/A'}
                </div>
            `;
            infoDiv.style.display = 'block';
        } else {
            infoDiv.innerHTML = `<div class="alert alert-danger-custom small">未找到该患者</div>`;
            infoDiv.style.display = 'block';
        }
    });
}
</script>
{% endblock %}

