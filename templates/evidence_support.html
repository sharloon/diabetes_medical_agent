{% extends 'base.html' %}

{% block title %}å¾ªè¯åŒ»å­¦æ”¯æŒ - ç³–å°¿ç—…æ™ºèƒ½è¯Šæ–­åŠ©æ‰‹{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="page-title"><i class="bi bi-journal-medical me-2"></i>å¾ªè¯åŒ»å­¦æ”¯æŒ</h2>
        <p class="page-subtitle">è¯æ®ç­‰çº§æ ‡æ³¨ã€å¤šæºçŸ¥è¯†èåˆ</p>
    </div>
</div>

<div class="row">
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-search me-2"></i>å¾ªè¯æ£€ç´¢
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">ä¸´åºŠé—®é¢˜</label>
                    <textarea class="form-control" id="evidenceQuery" rows="3" 
                              placeholder="è¾“å…¥ä¸´åºŠé—®é¢˜ï¼Œå¦‚ï¼šé«˜è¡€å‹åˆå¹¶ç³–å°¿ç—…çš„æ²»ç–—æ–¹æ¡ˆ">é«˜è¡€å‹åˆå¹¶ç³–å°¿ç—…æ‚£è€…çš„é™å‹è¯ç‰©é€‰æ‹©</textarea>
                </div>
                <button class="btn btn-primary w-100" onclick="searchEvidence()">
                    <i class="bi bi-search me-2"></i>æ£€ç´¢è¯æ®
                </button>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <i class="bi bi-info-circle me-2"></i>è¯æ®ç­‰çº§è¯´æ˜
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr><td><span class="badge bg-success">â… A</span></td><td>è¯æ®å……åˆ†ï¼Œå¼ºçƒˆæ¨è</td></tr>
                    <tr><td><span class="badge bg-primary">â… B</span></td><td>è¯æ®è¾ƒå……åˆ†ï¼Œæ¨è</td></tr>
                    <tr><td><span class="badge bg-info">â…¡A</span></td><td>è¯æ®æœ‰é™ï¼Œå¯ä»¥è€ƒè™‘</td></tr>
                    <tr><td><span class="badge bg-warning">â…¡B</span></td><td>è¯æ®ä¸è¶³ï¼Œå¯èƒ½æœ‰ç›Š</td></tr>
                    <tr><td><span class="badge bg-secondary">â…¢</span></td><td>è¯æ®ä¸è¶³æˆ–æœ‰å®³ï¼Œä¸æ¨è</td></tr>
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-file-medical me-2"></i>å¾ªè¯æ£€ç´¢ç»“æœ
            </div>
            <div class="card-body" id="evidenceResult">
                <div class="text-center text-muted py-5">
                    <i class="bi bi-journal-medical" style="font-size: 3rem;"></i>
                    <p class="mt-3">è¾“å…¥ä¸´åºŠé—®é¢˜è¿›è¡Œå¾ªè¯æ£€ç´¢</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function searchEvidence() {
    const query = document.getElementById('evidenceQuery').value.trim();
    if (!query) {
        alert('è¯·è¾“å…¥ä¸´åºŠé—®é¢˜');
        return;
    }
    
    const container = document.getElementById('evidenceResult');
    container.innerHTML = '<div class="text-center py-5"><div class="loading"><span></span><span></span><span></span></div><p class="mt-3">æ­£åœ¨æ£€ç´¢å¾ªè¯ä¾æ®...</p></div>';
    
    fetch('/api/evidence/search', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({query: query})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            renderEvidenceResults(data.data);
        } else {
            container.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        }
    });
}

function renderEvidenceResults(data) {
    const container = document.getElementById('evidenceResult');
    const searchResults = data.search_results;
    const answer = data.answer;
    
    let html = '';
    
    // ç»¼åˆå»ºè®®
    if (answer && answer.answer) {
        html += `
            <div class="card mb-4 border-primary">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-lightbulb me-2"></i>ç»¼åˆå†³ç­–å»ºè®®
                </div>
                <div class="card-body">
                    ${renderMarkdown(answer.answer)}
                </div>
            </div>
        `;
    }
    
    // çŸ¥è¯†èåˆè¿‡ç¨‹
    html += '<h5 class="mb-3"><i class="bi bi-diagram-3 me-2"></i>å¤šæºçŸ¥è¯†èåˆ</h5>';
    
    // PDFæŒ‡å—
    if (searchResults.pdf_results && searchResults.pdf_results.length > 0) {
        html += `
            <div class="card mb-3">
                <div class="card-header bg-primary bg-opacity-10">
                    <span class="source-tag pdf me-2">ğŸ“„ PDFæŒ‡å—</span>
                    <span class="badge bg-primary">${searchResults.pdf_results.length}æ¡</span>
                </div>
                <div class="card-body">
        `;
        searchResults.pdf_results.forEach((hit, idx) => {
            html += `
                <div class="mb-3 pb-3 ${idx < searchResults.pdf_results.length - 1 ? 'border-bottom' : ''}">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <small class="text-muted">${hit.source?.filename || ''} ç¬¬${hit.source?.page || ''}é¡µ</small>
                        <span class="badge bg-secondary">${(hit.score * 100).toFixed(0)}% ç›¸å…³</span>
                    </div>
                    <p class="mb-0 small">${hit.content?.substring(0, 400)}...</p>
                </div>
            `;
        });
        html += '</div></div>';
    }
    
    // MySQLæŒ‡å—æ¨è
    if (searchResults.mysql_results && searchResults.mysql_results.length > 0) {
        html += `
            <div class="card mb-3">
                <div class="card-header bg-warning bg-opacity-10">
                    <span class="source-tag mysql me-2">ğŸ—„ï¸ æŒ‡å—æ¨è</span>
                    <span class="badge bg-warning text-dark">${searchResults.mysql_results.length}æ¡</span>
                </div>
                <div class="card-body">
        `;
        searchResults.mysql_results.forEach((hit, idx) => {
            let evidenceBadge = '';
            if (hit.evidence_level) {
                const badgeClass = hit.evidence_level.includes('â… ') ? 'bg-success' : 
                                   hit.evidence_level.includes('â…¡') ? 'bg-info' : 'bg-secondary';
                evidenceBadge = `<span class="badge ${badgeClass} me-2">${hit.evidence_level}</span>`;
            }
            html += `
                <div class="mb-3 pb-3 ${idx < searchResults.mysql_results.length - 1 ? 'border-bottom' : ''}">
                    <div class="d-flex align-items-center mb-2">
                        ${evidenceBadge}
                        <small class="text-muted">${hit.source?.table || ''}</small>
                    </div>
                    <p class="mb-0">${hit.content}</p>
                </div>
            `;
        });
        html += '</div></div>';
    }
    
    // æ¥æºå¼•ç”¨
    if (answer && answer.sources && answer.sources.length > 0) {
        html += '<h6 class="mt-4">å‚è€ƒæ¥æº</h6><div class="d-flex flex-wrap gap-2">';
        answer.sources.forEach(source => {
            html += formatSource(source);
        });
        html += '</div>';
    }
    
    container.innerHTML = html;
}
</script>
{% endblock %}

